var test = require('tape');
var utils = require('../../..');
var consul = utils.config.consul;
var nock = require('nock');

test('Consul', {skip: false}, function(t) {
  t.test('Agent', {skip: false}, function(tt) {
    tt.test('throws error without name', function(ttt) {
      ttt.plan(1);
      consul.agent.register().then(function() {}, function(err) {
        ttt.equal(err.name, 'Error', 'throws error');
      });
    });

    tt.test('creates agent with default properties', function(ttt) {
      nock('http://127.0.0.1:8500')
        .put('/v1/agent/service/register')
        .reply(201, 'OK');
      nock('http://127.0.0.1:8500')
        .get('/v1/agent/service/deregister/foo_3000')
        .reply(201, 'OK');
      ttt.test('first agent gets created', function(tttt) {
        tttt.plan(2);
        consul.agent.register('foo').then(function(agent) {
          agent.deregister().then(function() {
            tttt.ok(1);
          });
          tttt.ok(1);
        }, function(err) {
          ttt.equal(err.name, 'Error', 'throws error');
        });
      });

      ttt.test('attempt to crate agent again', function(tttt) {
        nock('http://127.0.0.1:8500')
          .put('/v1/agent/service/register')
          .reply(201, 'OK');
        nock('http://127.0.0.1:8500')
          .get('/v1/agent/service/deregister/bar_3000')
          .reply(201, 'OK');
        tttt.plan(2);
        consul.agent.register('bar').then(function(agent) {
          agent.deregister().then(function() {
            tttt.ok(1);
          });
          tttt.ok(1);
        }, function(err) {
          ttt.equal(err.name, 'Error', 'throws error');
        });
      });

      ttt.test('attempt to crate agent again', function(tttt) {
        nock('http://127.0.0.1:8500')
          .put('/v1/agent/service/register')
          .reply(201, 'OK');
        nock('http://127.0.0.1:8500')
          .get('/v1/agent/service/deregister/bar_3002')
          .reply(201, 'OK');
        tttt.plan(2);
        consul.agent.register('bar', {port: 3002}).then(function(agent) {
          agent.deregister().then(function() {
            tttt.ok(1);
          });
          tttt.ok(1);
        }, function(err) {
          ttt.equal(err.name, 'Error', 'throws error');
        });
      });

      ttt.test('attempt to crate agent again', function(tttt) {
        nock('http://127.0.0.1:8500')
          .put('/v1/agent/service/register')
          .reply(201, 'OK');
        nock('http://127.0.0.1:8500')
          .get('/v1/agent/service/deregister/bar_3002')
          .reply(201, 'OK');
        tttt.plan(2);
        consul.agent.register('bar', {port: 3002}).then(function(agent) {
          agent.deregister().then(function() {
            tttt.ok(1);
          });
          tttt.ok(1);
        }, function(err) {
          ttt.equal(err.name, 'Error', 'throws error');
        });
      });
    });

    tt.end();
  });
});
