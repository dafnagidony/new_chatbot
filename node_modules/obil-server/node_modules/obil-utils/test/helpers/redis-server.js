var config = require('../../config');
var core = require('../..').core;
var spawn = require('child_process').spawn;
var redisSrv;
var port = exports.port = 6379;
var isStoreLocal = /localhost|\d{3}\.0\.0\.1/.test(config.store.host);

/**
 * connect
 * @param notFake <Boolean> flag to use redis
 */
exports.connect = function(fake) {
  // on remote hosts redis-server is already available or when using fake redis
  if (!isStoreLocal || fake) {
    return core.promise(function(resolve) {
      resolve();
    });
  }

  if (redisSrv) {
    return core.promise(function(resolve) {
      resolve();
    });
  }

  redisSrv = spawn('redis-server', ['--port', port, '--loglevel', 'verbose'], { stdio: 'ignore' });
  return core.promise.delay(1000);
};

exports.disconnect = function() {
  // on remote hosts will pretend closing connection
  if (!isStoreLocal) {
    return core.promise(function(resolve) {
      resolve('closed');
    });
  }

  if (!redisSrv) {
    return core.promise(function(resolve) {
      resolve();
    });
  }

  return core.promise(function(resolve) {
    redisSrv.kill();
    redisSrv.once('close', resolve);
    redisSrv = null;
    return resolve('closed');
  });
};
