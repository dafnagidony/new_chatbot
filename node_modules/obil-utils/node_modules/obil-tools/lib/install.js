#!/usr/bin/env node

var npm = require('npm');
const https = require('https');
const RE = /\https:\/\/artifactory.outbrain.com\/artifactory\/api\/npm\/VR-npm-repo\/(.)*/i;


function getPackageMetadata (url) {
  https.get(url, (res) => {
    res.on('data', (d) => {
      process.stdout.write(d);
    });

    res.on('end', (data) => {
      attemptInstall();
    });

  }).on('error', (e) => {
    console.error(e);
  });
}

function attemptInstall() {
  var packageUrl;
  npm.load((loadErr) => {
    if (loadErr) {
      return console.error(loadErr);
    }
    npm.commands.install((installErr) => {
      if (installErr) {
        if (installErr.message.match(RE)) {
          return getPackageMetadata(installErr.message.match(RE)[0]);
        }
        return console.log(installErr);
      }
      return true;
    });

    npm.on('log', function(msg) {
      console.log(msg);
    });
  });
};

attemptInstall();
