#!/usr/bin/env node

var https = require('https');
var url = require('url');
var npm = require('npm');
var path = require('path');
const pckg = require(path.join(process.cwd(), 'package.json'));
const options = url.parse('https://artifactory.outbrain.com/artifactory/api/npm/VR-npm-repo/' + pckg.name);

options.headers = {};
options.headers['Content-Type'] = 'application/json';

var isPublished = (data) => {
  if (!data || !data.versions) {
    return false;
  }
  var versions = Object.keys(data.versions);
  if (versions.indexOf(pckg.version) > -1) {
    return true;
  }
  return false;
};


https.request(options, (resp) => {
  var str = '';
  resp.on('data', (chunk) => {
    str += chunk;
  });

  resp.on('end', () => {
    if (isPublished(JSON.parse(str))) {
      return console.log(`Package ${pckg.name}-${pckg.version} is already published.`);
    };

    return npm.load((err1) => {
      if (err1) {
        return console.error(err1);
      }
      npm.commands.publish((err2) => {
        if (err2) {
          return console.error(err2);
        }
        return console.log(`Published ${pckg.name}-${pckg.version} to registry`);
      });
    });
  });
}).end();
